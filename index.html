<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador ALE-RR | Legislação Estadual</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' }
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          zIndex: { '60': '60', '70': '70', '80': '80', '100': '100', '1000': '1000' }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Estilos CSS do original permanecem aqui */
    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; overflow: hidden; display: flex; flex-direction: column; }
    
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #475569; }

    .option-card { transition: all 0.2s ease; border-width: 2px; }
    .option-card:hover:not(.disabled) { transform: translateX(4px); }
    .light .option-card { border-color: #e2e8f0; background-color: white; }
    .light .option-card:hover:not(.disabled) { border-color: #94a3b8; background-color: #f8fafc; }
    .dark .option-card { border-color: #334155; background-color: #1e293b; color: #e2e8f0; }
    .dark .option-card:hover:not(.disabled) { border-color: #64748b; background-color: #334155; }
    .option-card.selected { border-color: #f59e0b !important; background-color: #fffbeb !important; }
    .dark .option-card.selected { background-color: #451a03 !important; border-color: #f59e0b !important; }
    .option-card.correct { border-color: #10b981 !important; background-color: #ecfdf5 !important; }
    .dark .option-card.correct { background-color: #064e3b !important; border-color: #10b981 !important; }
    .option-card.wrong { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
    .dark .option-card.wrong { background-color: #450a0a !important; border-color: #ef4444 !important; }

    #pdf-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .drawer-open { transform: translateX(0) !important; }
    .drawer-closed { transform: translateX(100%); }
    
    .pdf-tab {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: translateY(-50%);
        box-shadow: -4px 0 10px rgba(0,0,0,0.1);
        z-index: 40;
    }

    .locked-checkbox { opacity: 0.5; pointer-events: none; background-color: #e2e8f0; }
    .dark .locked-checkbox { background-color: #334155; }

    @media (max-width: 768px) {
      .mobile-stack { flex-direction: column; }
      .mobile-full { width: 100%; }
      .mobile-padding { padding: 1rem; }
      .mobile-text-sm { font-size: 0.875rem; }
    }

    .focus-visible:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chart-container {
      position: relative;
      height: 200px;
      width: 200px;
    }

    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    /* Estilos específicos para gráficos 3D com Plotly */
    .plotly-3d-container {
      height: 500px;
      width: 100%;
      position: relative;
      background-color: #f8fafc;
      border-radius: 8px;
      overflow: hidden;
    }
    .dark .plotly-3d-container {
      background-color: #1e293b;
    }
    
    .plotly-error {
      display: none;
      padding: 2rem;
      text-align: center;
      color: #dc2626;
    }

    .chart-controls {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dark .chart-controls {
      background: rgba(30, 41, 59, 0.9);
    }

    /* Estilos para as tabelas roláveis */
    .metrics-table-container {
      max-height: 500px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .dark .metrics-table-container {
      border-color: #475569;
    }

    .evolution-line {
      stroke: #3b82f6;
      stroke-width: 2;
      fill: none;
      stroke-dasharray: 5, 5;
    }
    .dark .evolution-line {
      stroke: #60a5fa;
    }

    .metric-card {
      transition: all 0.2s ease;
      border-left: 4px solid #3b82f6;
    }
    .dark .metric-card {
      border-left-color: #60a5fa;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* Novos estilos para indicadores de evolução */
    .evolution-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 4px;
    }
    
    .evolution-positive {
      background-color: #10b98120;
      color: #10b981;
      border: 1px solid #10b98140;
    }
    
    .evolution-negative {
      background-color: #ef444420;
      color: #ef4444;
      border: 1px solid #ef444440;
    }
    
    .evolution-neutral {
      background-color: #6b728020;
      color: #6b7280;
      border: 1px solid #6b728040;
    }

    /* Estilos para tooltips personalizados */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      position: absolute;
      z-index: 10;
      background-color: #1e293b;
      color: #f8fafc;
      text-align: center;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      white-space: nowrap;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      pointer-events: none;
    }
    
    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1e293b transparent transparent transparent;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    .dark .tooltip .tooltip-text {
      background-color: #f8fafc;
      color: #1e293b;
    }
    
    .dark .tooltip .tooltip-text::after {
      border-color: #f8fafc transparent transparent transparent;
    }

    /* Estilos para mostrar nome completo em elementos truncados */
    .truncate-with-tooltip {
      position: relative;
    }
    
    .truncate-with-tooltip:hover::after {
      content: attr(data-fulltext);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #1e293b;
      color: #f8fafc;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      pointer-events: none;
      margin-bottom: 5px;
    }
    
    .dark .truncate-with-tooltip:hover::after {
      background-color: #f8fafc;
      color: #1e293b;
    }
    
    .truncate-with-tooltip:hover::before {
      content: "";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: #1e293b transparent transparent transparent;
      z-index: 11;
      margin-bottom: -5px;
    }
    
    .dark .truncate-with-tooltip:hover::before {
      border-color: #f8fafc transparent transparent transparent;
    }
    
    /* Estilos para os novos elementos de comentários e estatísticas */
    .comment-section {
      margin-top: 2rem;
      border-top: 1px solid #e2e8f0;
      padding-top: 1.5rem;
    }
    
    .dark .comment-section {
      border-top-color: #475569;
    }
    
    .comment-item {
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 1rem;
      margin-bottom: 1rem;
    }
    
    .dark .comment-item {
      border-bottom-color: #475569;
    }
    
    .comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #3b82f6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .comment-date {
      font-size: 0.75rem;
      color: #6b7280;
    }
    
    .dark .comment-date {
      color: #94a3b8;
    }
    
    .emoji-picker {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 50;
      max-width: 200px;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.25rem;
    }
    
    .dark .emoji-picker {
      background: #1f2937;
      border-color: #374151;
    }
    
    .emoji-option {
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      text-align: center;
      font-size: 1.25rem;
      transition: background-color 0.2s;
    }
    
    .emoji-option:hover {
      background-color: #f3f4f6;
    }
    
    .dark .emoji-option:hover {
      background-color: #374151;
    }
    
    .report-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 20;
    }
    
    .question-stats {
      background-color: #f8fafc;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .dark .question-stats {
      background-color: #1e293b;
    }
    
    .nav-buttons {
      position: relative;
      z-index: 5;
    }
    
    /* Estilos para os informativos modais corrigidos */
    .modal-informative {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      max-width: 90%;
      width: 400px;
      overflow: hidden;
    }
    
    .dark .modal-informative {
      background: #1f2937;
    }
    
    .modal-informative-content {
      padding: 1.5rem;
      position: relative;
    }
    
    /* Ajuste para garantir que os botões não sejam sobrepostos */
    .btn-container {
      position: relative;
      z-index: 5;
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* Correção para a justificativa não se propagar */
    #explanation-text {
      white-space: pre-line;
    }

    /* Estilo para respostas de comentários */
    .comment-responses {
      margin-top: 1rem;
      margin-left: 2rem;
      padding-left: 1rem;
      border-left: 2px solid #e2e8f0;
    }
    
    .dark .comment-responses {
      border-left-color: #475569;
    }

    /* Correção para sobreposição de módulo */
    #q-module-name {
      max-width: 100%;
      display: inline-block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }

    /* Ajuste para botões de like e resposta */
    .comment-actions {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .comment-actions button {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      transition: all 0.2s;
    }
    
    .comment-actions button:hover {
      background-color: #f3f4f6;
      color: #374151;
    }
    
    .dark .comment-actions button:hover {
      background-color: #374151;
      color: #f3faf6;
    }

    /* Estilos para editor de comentários */
    .comment-editor {
      min-height: 100px;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.75rem;
      outline: none;
    }
    
    .dark .comment-editor {
      border-color: #475569;
      background-color: #1e293b;
      color: #e2e8f0;
    }
    
    .comment-editor:focus {
      border-color: #3b82f6;
    }
    
    .formatting-toolbar {
      display: flex;
      gap: 0.25rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    
    .formatting-toolbar button {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e2e8f0;
      border-radius: 0.25rem;
      background: white;
      cursor: pointer;
      font-size: 0.875rem;
    }
    
    .dark .formatting-toolbar button {
      background: #334155;
      border-color: #475569;
      color: #e2e8f0;
    }
    
    .formatting-toolbar button:hover {
      background: #f3f4f6;
    }
    
    .dark .formatting-toolbar button:hover {
      background: #475569;
    }
    
    .comment-editor[contenteditable="true"]:empty:before {
      content: attr(placeholder);
      color: #9ca3af;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300">

  <nav class="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 h-16 shrink-0 z-50">
    <div class="container mx-auto px-4 h-full flex justify-between items-center">
      <div class="flex items-center gap-3 cursor-pointer group" onclick="showScreen('home')">
        <div class="bg-brand-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30 group-hover:scale-110 transition">
          <i class="fas fa-gavel"></i>
        </div>
        <div class="leading-tight">
          <h1 class="text-xl font-bold text-slate-800 dark:text-white">ALE-RR <span class="text-brand-600 dark:text-brand-500">Simulador</span></h1>
          <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest">Legislação Estadual</p>
        </div>
      </div>
      
      <div class="flex items-center gap-4">
        <button onclick="showScreen('home')" class="hidden md:flex items-center gap-2 text-sm font-bold text-slate-600 dark:text-slate-300 hover:text-brand-600 dark:hover:text-brand-400 px-3 py-2 rounded-lg hover:bg-brand-50 dark:hover:bg-brand-900/20 transition border border-transparent hover:border-brand-200">
          <i class="fas fa-home text-brand-500"></i> <span>Início</span>
        </button>

        <div class="h-6 w-px bg-slate-200 dark:bg-slate-600 hidden md:block"></div>

        <button onclick="toggleCacheModal()" class="text-slate-600 dark:text-slate-300 hover:text-brand-600 dark:hover:text-brand-400 p-2 transition" title="Gerenciar Dados">
            <i class="fas fa-database"></i>
        </button>

        <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition flex items-center justify-center">
          <i id="theme-icon" class="fas fa-moon"></i>
        </button>

        <button onclick="showScreen('analytics')" class="text-slate-600 dark:text-slate-300 hover:text-brand-600 dark:hover:text-brand-400 p-2 transition" title="Histórico">
          <i class="fas fa-chart-bar"></i>
        </button>
      </div>
    </div>
  </nav>

  <div class="flex-grow relative flex overflow-hidden">
    
    <main class="flex-grow overflow-y-auto custom-scrollbar p-4 md:p-8 relative z-10 w-full" id="main-scroll-area">
        
        <div id="screen-error" class="hidden flex flex-col items-center justify-center min-h-[60vh] text-center fade-in">
            <div class="w-24 h-24 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mb-6 text-4xl shadow-xl">
                <i class="fas fa-server"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">Erro de Conexão Local</h2>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-slate-700 max-w-lg mx-auto text-left">
                <p class="text-slate-600 dark:text-slate-300 mb-4 font-medium">Use a extensão <strong>Live Server</strong> para rodar este aplicativo corretamente.</p>
            </div>
            <button onclick="location.reload()" class="mt-8 bg-brand-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-brand-700 transition shadow-lg flex items-center gap-2">
                <i class="fas fa-sync-alt"></i> Tentar Novamente
            </button>
        </div>

        <div id="screen-home" class="fade-in max-w-6xl mx-auto pb-24">
            <!-- Card para retomar simulado pausado -->
            <div id="paused-alert" class="hidden bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 mb-6">
                <h3 class="text-lg font-bold text-amber-800 dark:text-amber-200">Simulado Pausado</h3>
                <p class="text-sm text-amber-600 dark:text-amber-300">Você tem um simulado em pausa. Deseja retomar?</p>
                <div class="mt-4 flex gap-3">
                    <button onclick="resumeSimulation()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-bold">Retomar Simulado</button>
                    <button onclick="discardPaused()" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold">Descartar</button>
                </div>
            </div>

            <!-- Configuração do simulador -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-6 md:p-10 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-slate-50 to-white dark:from-slate-900 dark:to-slate-800">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-extrabold text-slate-800 dark:text-white mb-2">Configurar Simulador</h2>
                            <p class="text-slate-500 dark:text-slate-400">Selecione os tópicos e a estratégia de distribuição.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Assembleia Legislativa</label>
                            <div class="flex items-center gap-2">
                                <div class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold min-w-[200px] text-center">
                                    ALE-RR - Roraima
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-7 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <label class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2 uppercase tracking-wide text-sm">
                                <i class="fas fa-list-ul text-brand-500"></i> Assuntos Disponíveis
                            </label>
                            <div class="space-x-3">
                                <button onclick="toggleAllModules(true)" id="btn-select-all" class="text-xs font-bold text-brand-600 hover:underline">Todos</button>
                                <button onclick="toggleAllModules(false)" id="btn-select-none" class="text-xs font-bold text-slate-500 hover:text-red-500">Nenhum</button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-200 dark:border-slate-600 flex-grow max-h-[500px] overflow-y-auto custom-scrollbar p-1" id="module-container">
                            <div class="p-8 text-center text-slate-400"><div class="loader mx-auto mb-2"></div> Carregando módulos...</div>
                        </div>

                        <div class="mt-4 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Banco de Dados</span>
                                    <span id="badge-total" class="text-lg font-bold text-slate-800 dark:text-white">0</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Módulos Selecionados</span>
                                    <span id="badge-modules" class="text-lg font-bold text-slate-800 dark:text-white">0</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Q. Selecionadas</span>
                                    <span id="badge-available" class="text-lg font-bold text-slate-800 dark:text-white">0</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-blue-700 dark:text-blue-300">Para o Simulado</span>
                                    <span id="badge-target" class="text-lg font-bold text-slate-800 dark:text-white">0</span>
                                </div>
                            </div>
                            <div class="mt-3 text-xs text-blue-600 dark:text-blue-400 text-center">
                                <i class="fas fa-info-circle mr-1"></i> As questões foram elaboradas com IA e as de 2018 são do concurso anterior (atualizadas).
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-5 flex flex-col gap-6">
                        
                        <div class="bg-orange-50 dark:bg-orange-900/10 p-5 rounded-xl border border-orange-100 dark:border-orange-800/30 relative overflow-hidden group">
                            <div class="absolute right-0 top-0 w-20 h-20 bg-orange-100 dark:bg-orange-800/20 rounded-bl-full -mr-4 -mt-4 transition group-hover:scale-110"></div>
                            <div class="relative z-10 flex items-center justify-between">
                                <div>
                                    <div class="font-bold text-orange-800 dark:text-orange-200">Filtro Concurso 2018</div>
                                    <div class="text-[10px] text-orange-600 dark:text-orange-300 mt-1 max-w-[150px]">
                                        Trava a seleção apenas para questões da prova anterior.
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="filter-2018" class="sr-only peer" onchange="toggle2018Lock()">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                                </label>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div id="qty-selector-container">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Quantidade Total</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <button onclick="setQuantity(5, event)" class="btn-qty p-2 rounded border hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 text-sm font-medium transition" data-val="5">5</button>
                                    <button onclick="setQuantity(10, event)" class="btn-qty p-2 rounded border bg-brand-50 border-brand-500 text-brand-700 dark:bg-brand-900/30 dark:text-brand-300 text-sm font-medium transition" data-val="10">10</button>
                                    <button onclick="setQuantity(20, event)" class="btn-qty p-2 rounded border hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 text-sm font-medium transition" data-val="20">20</button>
                                    <button onclick="setQuantity(30, event)" class="btn-qty p-2 rounded border hover:bg-slate-50 dark:border-slate-600 dark:hover:bg-slate-700 text-sm font-medium transition" data-val="30">30</button>
                                </div>
                                <div class="mt-2 flex gap-2">
                                    <button onclick="setQuantity('all', event)" class="flex-1 btn-qty p-2 rounded border border-purple-200 text-purple-700 bg-purple-50 hover:bg-purple-100 text-xs font-bold uppercase transition" data-val="all">Selecionar Tudo</button>
                                    <input type="number" id="custom-qty" placeholder="Qtd..." class="w-20 p-2 text-sm border rounded text-center outline-none focus:border-brand-500 dark:bg-slate-700 dark:border-slate-600" oninput="setQuantity('custom', event)">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Modo de Distribuição</label>
                                <select id="distribution-mode" onchange="handleModeChange()" class="w-full p-2.5 text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-700 dark:text-slate-200">
                                    <option value="random">Aleatório Simples</option>
                                    <option value="balanced">Equilibrado (Por Tópico)</option>
                                    <option value="proportional">Proporcional (Peso)</option>
                                    <option value="manual">Manual / Personalizado</option>
                                </select>
                            </div>

                            <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-600 p-3">
                                <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2 flex justify-between">
                                    <span>Previsão do Simulado</span>
                                    <span id="preview-total" class="text-brand-600">0 questões</span>
                                </h4>
                                <div id="distribution-preview" class="max-h-[150px] overflow-y-auto custom-scrollbar space-y-1 text-xs text-slate-600 dark:text-slate-300">
                                    <p class="text-slate-400 italic">Selecione módulos para ver.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
                    <button onclick="startSimulation()" class="w-full bg-brand-600 hover:bg-brand-700 text-white text-lg font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-0.5 flex justify-center items-center gap-3">
                        INICIAR SIMULADO <i class="fas fa-arrow-right"></i>
                    </button>
                    <div class="mt-4 flex flex-col md:flex-row justify-between items-center text-xs text-slate-500 dark:text-slate-400">
                        <div class="text-center md:text-left">
                            <p>Desenvolvido por <strong>Marcos Guimarães Duailibi Filho</strong></p>
                            <p class="mt-0.5">Contato: +55 (95) 98111-4983</p>
                        </div>
                        
                        <div class="mt-2 md:mt-0 flex items-center gap-2 bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-full border border-slate-200 dark:border-slate-600" title="Uso do Armazenamento Local">
                            <i class="fas fa-database text-xs text-slate-400"></i>
                            <span class="font-mono text-[10px]" id="footer-cache-stat">0 KB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela do Simulado -->
        <div id="screen-quiz" class="hidden max-w-6xl mx-auto fade-in">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="lg:w-2/3">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-slate-50 to-white dark:from-slate-900 dark:to-slate-800">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <div class="text-xs font-bold text-slate-500 uppercase mb-1">Questão <span id="q-current-index">1</span>/<span id="q-total-count">10</span></div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-sm font-bold text-brand-600 dark:text-brand-400 truncate-with-tooltip" id="q-module-name" data-fulltext=""></div>
                                        <div class="tooltip">
                                            <i class="fas fa-info-circle text-slate-400"></i>
                                            <span class="tooltip-text" id="q-module-name-tooltip"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="text-right">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Tempo</div>
                                        <div class="text-xl font-bold text-slate-700 dark:text-white" id="timer">00:00</div>
                                    </div>
                                    <button onclick="pauseSimulation()" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-4 py-2 rounded-lg font-bold transition">
                                        <i class="fas fa-pause mr-2"></i> Pausar
                                    </button>
                                </div>
                            </div>
                            <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2">
                                <div id="progress-bar" class="bg-brand-500 h-2 rounded-full transition-all duration-300" style="width: 10%"></div>
                            </div>
                        </div>

                        <div class="p-6 md:p-8">
                            <div class="mb-8">
                                <div class="text-lg md:text-xl text-slate-800 dark:text-slate-100 font-medium leading-relaxed" id="q-text"></div>
                            </div>

                            <div id="options-container" class="space-y-4">
                                <!-- As opções serão carregadas aqui -->
                            </div>

                            <div id="explanation-box" class="hidden mt-8 p-6 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-200 dark:border-slate-600">
                                <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Justificativa</h4>
                                <p id="explanation-text" class="text-slate-600 dark:text-slate-300"></p>
                            </div>

                            <div id="question-stats" class="hidden mt-8 p-6 bg-slate-50 dark:bg-slate-700/50 rounded-xl border border-slate-200 dark:border-slate-600">
                                <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200 mb-4">Estatísticas da Questão</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500">Taxa de Acerto</div>
                                        <div class="text-lg font-bold text-green-600" id="stats-correct-rate">85%</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500">Tempo Médio</div>
                                        <div class="text-lg font-bold text-blue-600" id="stats-avg-time">45s</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500">Tentativas</div>
                                        <div class="text-lg font-bold text-purple-600" id="stats-attempts">127</div>
                                    </div>
                                </div>
                            </div>

                            <div id="comments-section" class="hidden mt-8">
                                <h4 class="text-sm font-bold text-slate-700 dark:text-slate-200 mb-4">Comentários</h4>
                                <div class="mb-6">
                                    <div class="relative">
                                        <div id="new-comment-editor" class="comment-editor" contenteditable="true" placeholder="Escreva seu comentário..."></div>
                                        <div class="formatting-toolbar">
                                            <button onclick="formatText('bold')" title="Negrito"><i class="fas fa-bold"></i></button>
                                            <button onclick="formatText('italic')" title="Itálico"><i class="fas fa-italic"></i></button>
                                            <button onclick="formatText('underline')" title="Sublinhado"><i class="fas fa-underline"></i></button>
                                            <button onclick="toggleEmojiPicker()" title="Emoji"><i class="far fa-smile"></i></button>
                                            <div id="emoji-picker" class="emoji-picker hidden"></div>
                                        </div>
                                    </div>
                                    <button onclick="addComment()" class="mt-4 bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg font-bold transition">
                                        <i class="fas fa-paper-plane mr-2"></i> Enviar Comentário
                                    </button>
                                </div>
                                <div id="comments-list">
                                    <!-- Comentários serão carregados aqui -->
                                </div>
                                <button onclick="loadMoreComments()" class="w-full mt-4 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-4 py-2 rounded-lg font-bold transition">
                                    <i class="fas fa-chevron-down mr-2"></i> Carregar mais comentários
                                </button>
                            </div>

                            <div class="mt-8 flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button onclick="toggleSection('explanation')" class="px-4 py-2 text-sm font-bold rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition">Justificativa</button>
                                    <button onclick="toggleSection('stats')" class="px-4 py-2 text-sm font-bold rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition">Estatísticas</button>
                                    <button onclick="toggleSection('comments')" class="px-4 py-2 text-sm font-bold rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-600 transition">Comentários</button>
                                    <button onclick="showReportModal()" class="px-4 py-2 text-sm font-bold rounded-lg bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-300 hover:bg-red-100 dark:hover:bg-red-900/50 transition">
                                        <i class="fas fa-flag mr-1"></i> Reportar
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <button id="btn-prev" onclick="changeQuestion(-1)" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-6 py-2 rounded-lg font-bold transition mobile-full" disabled>
                                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                                    </button>
                                    <button id="btn-confirm" onclick="confirmAnswer()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold transition mobile-full" disabled>
                                        Confirmar Resposta
                                    </button>
                                    <button id="btn-next" onclick="changeQuestion(1)" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-6 py-2 rounded-lg font-bold transition mobile-full">
                                        Próxima <i class="fas fa-arrow-right ml-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:w-1/3">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden h-full">
                        <div class="p-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white">Navegação</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Clique em uma questão para visualizar</p>
                        </div>
                        <div class="p-4">
                            <div id="nav-grid" class="grid grid-cols-5 gap-2">
                                <!-- Os pontos de navegação serão gerados aqui -->
                            </div>
                        </div>
                        <div class="p-4 border-t border-slate-100 dark:border-slate-700">
                            <button onclick="abandonSimulation()" class="w-full bg-red-50 hover:bg-red-100 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-600 dark:text-red-300 px-4 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
                                <i class="fas fa-times"></i> Abandonar Simulado
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela de Resultados -->
        <div id="screen-result" class="hidden max-w-6xl mx-auto fade-in">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-8 text-center">
                    <div class="w-24 h-24 bg-green-100 dark:bg-green-900/30 text-green-500 rounded-full flex items-center justify-center mb-6 text-4xl shadow-xl mx-auto">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">Simulado Finalizado!</h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-8">Confira seu desempenho e continue praticando.</p>
                </div>

                <div class="p-8 border-t border-slate-100 dark:border-slate-700">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-6">Desempenho por Módulo</h3>
                            <div id="module-performance" class="space-y-4">
                                <!-- Estatísticas por módulo serão carregadas aqui -->
                            </div>
                        </div>
                        <div class="lg:col-span-1">
                            <div class="sticky top-8">
                                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6">
                                    <h4 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Resumo</h4>
                                    <div class="space-y-4">
                                        <div class="flex justify-between">
                                            <span class="text-slate-600 dark:text-slate-300">Acertos</span>
                                            <span id="res-correct" class="text-2xl font-bold text-green-600">0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-600 dark:text-slate-300">Erros</span>
                                            <span id="res-wrong" class="text-2xl font-bold text-red-600">0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-600 dark:text-slate-300">Em branco</span>
                                            <span id="res-unanswered" class="text-2xl font-bold text-slate-400">0</span>
                                        </div>
                                        <div class="pt-4 border-t border-slate-200 dark:border-slate-600">
                                            <div class="flex justify-between items-center">
                                                <span class="text-lg font-bold text-slate-800 dark:text-white">Percentual</span>
                                                <span id="res-percent" class="text-3xl font-bold text-brand-600">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-6 bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6">
                                    <div class="h-48">
                                        <canvas id="resultChart"></canvas>
                                    </div>
                                </div>
                                <div class="mt-6 flex flex-col gap-3">
                                    <button onclick="showScreen('home')" class="w-full bg-brand-600 hover:bg-brand-700 text-white px-6 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
                                        <i class="fas fa-redo"></i> Novo Simulado
                                    </button>
                                    <button onclick="showScreen('analytics')" class="w-full bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-6 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
                                        <i class="fas fa-chart-bar"></i> Ver Histórico
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela de Analytics -->
        <div id="screen-analytics" class="hidden max-w-6xl mx-auto pb-24 fade-in">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-8">
                <div class="p-6 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-slate-50 to-white dark:from-slate-900 dark:to-slate-800">
                    <h2 class="text-3xl font-extrabold text-slate-800 dark:text-white mb-2">Análises e Estatísticas</h2>
                    <p class="text-slate-500 dark:text-slate-400">Acompanhe seu progresso e desempenho ao longo do tempo.</p>
                </div>

                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="metric-card bg-white dark:bg-slate-700 p-5 rounded-xl shadow border border-slate-200 dark:border-slate-600">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Total de Simulados</h3>
                            <div class="flex items-end justify-between">
                                <div>
                                    <div class="text-3xl font-bold text-brand-600" id="metric-total-simulations">0</div>
                                    <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">Realizados até agora</div>
                                </div>
                                <div class="evolution-badge evolution-neutral">+0%</div>
                            </div>
                        </div>
                        <div class="metric-card bg-white dark:bg-slate-700 p-5 rounded-xl shadow border border-slate-200 dark:border-slate-600">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Melhor Desempenho</h3>
                            <div class="flex items-end justify-between">
                                <div>
                                    <div class="text-3xl font-bold text-green-600" id="metric-best-score">0%</div>
                                    <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">Maior percentual de acerto</div>
                                </div>
                                <div class="evolution-badge evolution-positive">+0%</div>
                            </div>
                        </div>
                        <div class="metric-card bg-white dark:bg-slate-700 p-5 rounded-xl shadow border border-slate-200 dark:border-slate-600">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">Tempo Médio por Questão</h3>
                            <div class="flex items-end justify-between">
                                <div>
                                    <div class="text-3xl font-bold text-blue-600" id="metric-avg-time">0s</div>
                                    <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">Tempo médio gasto</div>
                                </div>
                                <div class="evolution-badge evolution-negative">-0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6 border border-slate-200 dark:border-slate-600">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-6">Evolução do Desempenho</h3>
                            <div class="h-80">
                                <canvas id="historyChart"></canvas>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button id="hist-filter-all" onclick="setHistoryFilter('days', 'all')" class="px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700">Todo período</button>
                                <button id="hist-filter-1" onclick="setHistoryFilter('days', '1')" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">Últimos 30 dias</button>
                                <button id="hist-filter-7" onclick="setHistoryFilter('days', '7')" class="px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">Últimos 7 dias</button>
                            </div>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6 border border-slate-200 dark:border-slate-600">
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-6">Distribuição por Módulo</h3>
                            <div class="h-80">
                                <canvas id="distributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6 border border-slate-200 dark:border-slate-600">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-6">Tendência de Acertos</h3>
                        <div class="h-80">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white">Histórico Completo</h3>
                            <p class="text-slate-500 dark:text-slate-400">Visualize todos os simulados realizados</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportHistoryCSV()" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-4 py-2 rounded-lg font-bold transition">
                                <i class="fas fa-download mr-2"></i> Exportar CSV
                            </button>
                            <button onclick="importHistoryCSV()" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg font-bold transition">
                                <i class="fas fa-upload mr-2"></i> Importar
                            </button>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div class="metrics-table-container">
                            <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                                <thead class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase bg-slate-100 dark:bg-slate-800">
                                    <tr>
                                        <th class="px-4 py-3">Data</th>
                                        <th class="px-4 py-3">Acertos</th>
                                        <th class="px-4 py-3">Erros</th>
                                        <th class="px-4 py-3">Branco</th>
                                        <th class="px-4 py-3">Percentual</th>
                                        <th class="px-4 py-3">Tempo</th>
                                        <th class="px-4 py-3">Módulos</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body">
                                    <!-- Histórico será carregado aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela de Pausa -->
        <div id="screen-pause" class="hidden max-w-4xl mx-auto fade-in">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-8 text-center">
                    <div class="w-24 h-24 bg-amber-100 dark:bg-amber-900/30 text-amber-500 rounded-full flex items-center justify-center mb-6 text-4xl shadow-xl mx-auto">
                        <i class="fas fa-pause"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">Simulado Pausado</h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-8">Você pode retomar de onde parou a qualquer momento.</p>
                </div>

                <div class="p-8 border-t border-slate-100 dark:border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-5 text-center">
                            <div class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-2">Progresso</div>
                            <div class="text-2xl font-bold text-brand-600" id="paused-progress">0/0</div>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-5 text-center">
                            <div class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-2">Acertos até agora</div>
                            <div class="text-2xl font-bold text-green-600" id="paused-correct">0</div>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-5 text-center">
                            <div class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-2">Tempo decorrido</div>
                            <div class="text-2xl font-bold text-blue-600" id="paused-time">00:00</div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="resumeSimulation()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
                            <i class="fas fa-play mr-2"></i> Retomar Simulado
                        </button>
                        <button onclick="showScreen('home')" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-8 py-3 rounded-lg font-bold transition">
                            Voltar ao Início
                        </button>
                        <button onclick="abandonSimulation()" class="bg-red-50 hover:bg-red-100 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-600 dark:text-red-300 px-8 py-3 rounded-lg font-bold transition">
                            Abandonar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Drawer de PDF ajustado para múltiplos documentos -->
    <div id="pdf-drawer" class="fixed top-16 right-0 w-[90%] md:w-[600px] h-[calc(100vh-4rem)] bg-white dark:bg-slate-800 shadow-2xl border-l border-slate-200 dark:border-slate-700 z-50 transform translate-x-full flex flex-col transition-transform duration-300">
        <div class="flex items-center justify-between p-3 bg-slate-100 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
            <span class="font-bold text-sm text-slate-700 dark:text-slate-200"><i class="fas fa-book mr-2"></i> <span id="pdf-title">Documento de Apoio</span></span>
            <div class="flex gap-2">
                <a id="pdf-external-link" href="#" target="_blank" class="text-xs text-brand-600 hover:underline flex items-center"><i class="fas fa-external-link-alt mr-1"></i> Abrir Janela</a>
                <button onclick="togglePdfDrawer()" class="w-6 h-6 rounded hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="flex-grow bg-slate-200 relative">
            <object id="pdf-viewer" data="" type="application/pdf" class="w-full h-full">
                <div class="flex flex-col items-center justify-center h-full text-slate-500 p-4 text-center">
                    <p>Visualizador indisponível.</p>
                    <a id="pdf-download-link" href="#" target="_blank" class="text-brand-600 font-bold underline mt-2">Baixar PDF</a>
                </div>
            </object>
        </div>
        <div onclick="togglePdfDrawer()" class="absolute left-0 top-1/2 -translate-x-full cursor-pointer bg-red-600 text-white py-4 px-1 rounded-l-lg shadow-lg hover:bg-red-700 transition pdf-tab z-50 flex items-center gap-2 justify-center" title="Abrir Documento">
             <i class="fas fa-book-open rotate-90 mb-2"></i> <span class="font-bold text-xs tracking-widest uppercase">Documento</span>
        </div>
    </div>

    <!-- Modal de cache -->
    <div id="cache-modal" class="fixed inset-0 z-[80] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="modal-informative w-full max-w-md">
            <div class="modal-informative-content">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Gerenciar Dados</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Armazenamento Local</label>
                        <div class="bg-slate-100 dark:bg-slate-700 rounded h-4 w-full overflow-hidden">
                            <div id="cache-bar" class="bg-brand-500 h-full" style="width: 30%"></div>
                        </div>
                        <div class="text-xs text-slate-500 dark:text-slate-400 mt-2" id="cache-usage-text">0 KB</div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-700 dark:text-slate-300">Salvar histórico automaticamente</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-save-history" class="sr-only peer" onchange="toggleHistorySaving()" checked>
                            <div class="w-11 h-6 bg-slate-200 peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="pt-4 border-t border-slate-200 dark:border-slate-600">
                        <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Limpar Histórico</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="clearHistory('1h')" class="text-xs bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-3 py-2 rounded">Última hora</button>
                            <button onclick="clearHistory('24h')" class="text-xs bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-3 py-2 rounded">Último dia</button>
                            <button onclick="clearHistory('week')" class="text-xs bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-3 py-2 rounded">Última semana</button>
                            <button onclick="clearHistory('month')" class="text-xs bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-3 py-2 rounded">Último mês</button>
                            <button onclick="clearHistory('all')" class="text-xs bg-red-50 hover:bg-red-100 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-600 dark:text-red-300 px-3 py-2 rounded col-span-2">Limpar Tudo</button>
                        </div>
                    </div>
                </div>
                <div class="btn-container">
                    <button onclick="toggleCacheModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold transition">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de reportar problema -->
    <div id="report-modal" class="fixed inset-0 z-[1000] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="modal-informative w-full max-w-md">
            <div class="modal-informative-content">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Reportar Problema</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Tipo de problema</label>
                        <select id="report-type" class="w-full p-2 text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-700 dark:text-slate-200">
                            <option value="erro">Erro na questão</option>
                            <option value="alternativa">Alternativa incorreta</option>
                            <option value="justificativa">Justificativa incorreta</option>
                            <option value="interface">Problema na interface</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Descrição</label>
                        <textarea id="report-description" rows="4" class="w-full p-2 text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-700 dark:text-slate-200" placeholder="Descreva o problema encontrado..."></textarea>
                    </div>
                </div>
                <div class="btn-container">
                    <button onclick="closeReportModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold transition">Cancelar</button>
                    <button onclick="submitReport()" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg font-bold transition">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de reportar comentário -->
    <div id="report-comment-modal" class="fixed inset-0 z-[1000] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="modal-informative w-full max-w-md">
            <div class="modal-informative-content">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Reportar Comentário</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Motivo do reporte</label>
                        <select id="report-comment-type" class="w-full p-2 text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-700 dark:text-slate-200">
                            <option value="spam">Spam</option>
                            <option value="conteudo_improprio">Conteúdo impróprio</option>
                            <option value="desinformacao">Desinformação</option>
                            <option value="ofensa">Ofensa ou assédio</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Descrição</label>
                        <textarea id="report-comment-description" rows="4" class="w-full p-2 text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-700 dark:text-slate-200" placeholder="Descreva o motivo do reporte..."></textarea>
                    </div>
                </div>
                <div class="btn-container">
                    <button onclick="closeReportCommentModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold transition">Cancelar</button>
                    <button onclick="submitCommentReport()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold transition">Reportar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal informativo -->
    <div id="warning-modal" class="fixed inset-0 z-[1000] bg-black/60 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="modal-informative w-full max-w-md">
            <div class="modal-informative-content">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Atenção</h3>
                <p class="text-slate-600 dark:text-slate-300 mb-6">A quantidade solicitada excede o número de questões disponíveis. Deseja usar todas as questões disponíveis?</p>
                <div class="btn-container">
                    <button onclick="document.getElementById('warning-modal').classList.add('hidden');" class="flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold transition">Cancelar</button>
                    <button onclick="useAllAvailableQuestions()" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg font-bold transition">Usar Todas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de importação CSV -->
    <div id="csv-import-modal" class="fixed inset-0 z-[1000] bg-black/50 hidden flex items-center justify-center backdrop-blur-sm fade-in">
        <div class="modal-informative w-full max-w-md">
            <div class="modal-informative-content">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Importar Histórico</h3>
                <div class="space-y-4">
                    <p class="text-slate-600 dark:text-slate-300">Selecione um arquivo CSV para importar o histórico de simulados.</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="w-full p-2 text-sm bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 text-slate-700 dark:text-slate-200">
                    <div class="bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg">
                        <p class="text-xs text-amber-700 dark:text-amber-300">Atenção: A importação substituirá o histórico atual.</p>
                    </div>
                </div>
                <div class="btn-container">
                    <button onclick="closeCSVImportModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white px-4 py-2 rounded-lg font-bold transition">Cancelar</button>
                    <button onclick="processCSVImport()" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg font-bold transition">Importar</button>
                </div>
            </div>
        </div>
    </div>

  </div>

  <script>
    // ============================================
    // CONFIGURAÇÃO ESPECÍFICA PARA ALE-RR
    // ============================================
    const assembleiaAtual = 'ALRR';
    
    // Banco de dados de questões da ALE-RR - INCLUINDO LEI COMPLEMENTAR 53/2001
    const topicos = {
      'Constituição Estadual de Roraima': {
        path: 'src/constituicao-estadual-rr/',
        files: [
          'administracao-publica-e-servidores.json',
          'direitos-e-garantias-fundamentais.json',
          'disposicoes-transitores-e-conclusao.json',
          'ordem-economica-social-e-meio-ambiente.json',
          'organizacao-politico-administrativa-e-competencias.json',
          'poder-executivo.json',
          'poder-judiciario-e-funcoes-essenciais-a-justica.json',
          'poder-legislativo.json',
          'principios-fundamentais-e-objetivos-do-estado.json',
          'tributacao-financas-e-orcamento.json'
        ],
        pdf: 'src/constituicao-estadual-rr/constituicao-estadual-rr-atualizada-2026.pdf'
      },
      'Lei Complementar 53/2001': {
        path: 'src/lc-53-2001/',
        files: [
          'das-disposicoes-gerais.json',
          'do-disposicoes-preliminares.json',
          'do-processo-administrativo-disciplinar.json',
          'do-provimento-vacancia-remocao-e-substituicao.json',
          'do-regime-disciplinar.json',
          'dos-beneficios-sociais.json',
          'dos-direitos-e-vantagens.json'
        ],
        pdf: 'src/lc-53-2001/lei-complementar-53-2001.pdf'
      },
      'Regimento Interno ALE-RR 2023': {
        path: 'src/regimento-interno-ale-rr-2023/',
        files: [
          'da-interpretacao-e-observancia-do-regimento-titulo-VI.json',
          'da-ordem-interna-da-assembleia-titulo-IX.json',
          'da-participacao-da-sociedade-civil.titulo-IV.json',
          'da-representacao-parlamentar-titulo-III.json',
          'das-disposicoes-finais-titulo-XI.json',
          'disposicoes-preliminares-titulo-I.json',
          'do-processo-por-crime-de-responsabilidade-da-convocacao-de-secretarios-e-do-credenciamento-de-imprensa-titulo-X.json',
          'dos-debates-e-das-deliberacoes-titulo-VIII.json',
          'orgaos-da-assembleia-titulo-II.json',
          'questoes-concurso-2018.json',
          'sessoes-da-assembleia-titulo-V.json'
        ],
        pdf: 'src/regimento-interno-ale-rr-2023/regimento-interno-2023-ale-rr.pdf'
      }
    };

    // Variáveis Globais de Chart.js (2D)
    let historyChartInstance = null;
    let distributionChartInstance = null;
    let trendChartInstance = null;
    let resultChartInstance = null;
    
    // Variáveis para Plotly.js (3D)
    let overall3dChartInstance = null;
    let module3dChartInstance = null;
    
    let fullDatabase = [];
    let availableModules = [];
    
    // Filtros
    let historyFilters = {
        days: 'all',
        module: 'all'
    };

    let analytics3dFilters = {
        days: 'all',
        module: 'all'
    };
    
    let appState = {
        questions: [],
        index: 0,
        answers: [],
        timer: null,
        config: { qty: 10, modules: [], filter2018: false, mode: 'random' },
        moduleCounts: {}, 
        moduleCounts2018: {}, 
        distribution: {},
        savingEnabled: true,
        startTime: null,
        isPaused: false,
        currentSection: 'explanation'
    };

    // Variáveis para gerenciar likes dos comentários
    let userId = localStorage.getItem('alerr_userId');
    if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('alerr_userId', userId);
    }

    // ============================================
    // FUNÇÕES PLOTLY.JS (3D) COM TABELAS
    // ============================================

    function init3dCharts() {
        console.log("Plotly.js carregado e pronto para gráficos 3D");
    }

    // ============================================
    // FUNÇÕES PRINCIPAIS DO SIMULADOR
    // ============================================

    async function loadDatabase() {
        try {
            showLoadingState(true);
            
            const cacheKey = `alerr_fullDatabase_ALRR`;
            const cachedData = localStorage.getItem(cacheKey);
            const cacheTimestamp = localStorage.getItem(`alerr_cacheTimestamp_ALRR`);
            const oneDay = 24 * 60 * 60 * 1000;
            
            if (cachedData && cacheTimestamp && (Date.now() - parseInt(cacheTimestamp)) < oneDay) {
                const parsedData = JSON.parse(cachedData);
                fullDatabase = parsedData.database;
                appState.moduleCounts = parsedData.moduleCounts;
                appState.moduleCounts2018 = parsedData.moduleCounts2018;
                
                console.log("Dados carregados do cache para ALE-RR");
                renderModules();
                updateDistribution();
                showLoadingState(false);
                
                const paused = localStorage.getItem(`alerr_paused_sim_ALRR`);
                if (paused) {
                    document.getElementById('paused-alert').classList.remove('hidden');
                }
                
                showScreen('home');
                return;
            }
            
            // Carregar todos os tópicos
            let allQs = [];
            
            // Para cada tópico, carregar seus arquivos
            for (const [topico, info] of Object.entries(topicos)) {
                const promises = info.files.map(file => 
                    fetch(info.path + file)
                        .then(res => {
                            if (!res.ok) throw new Error(`Erro ao carregar ${file}: ${res.status}`);
                            return res.json().then(data => ({ data, file, topico }));
                        })
                        .catch(error => {
                            console.error(`Erro ao carregar ${file}:`, error);
                            return { data: [], file, topico, error: true };
                        })
                );
                
                const results = await Promise.all(promises);
                results.forEach(item => {
                    if (item.error) return;
                    
                    const is2018File = item.file.includes('questoes-concurso-2018.json');
                    const qs = item.data.map((q, i) => normalizeQuestion(q, i, item.topico, item.file, is2018File));
                    allQs = allQs.concat(qs);
                });
            }
            
            fullDatabase = allQs;
            
            // Inicializar contadores
            appState.moduleCounts = {};
            appState.moduleCounts2018 = {};
            
            fullDatabase.forEach(q => {
                appState.moduleCounts[q.module] = (appState.moduleCounts[q.module] || 0) + 1;
                if(q.is2018) appState.moduleCounts2018[q.module] = (appState.moduleCounts2018[q.module] || 0) + 1;
            });
            
            availableModules = [...new Set(fullDatabase.map(q => q.module))].sort();
            
            const cacheData = {
                database: fullDatabase,
                moduleCounts: appState.moduleCounts,
                moduleCounts2018: appState.moduleCounts2018
            };
            localStorage.setItem(cacheKey, JSON.stringify(cacheData));
            localStorage.setItem(`alerr_cacheTimestamp_ALRR`, Date.now().toString());
            
            renderModules();
            updateDistribution();
            showLoadingState(false);
            
            const paused = localStorage.getItem(`alerr_paused_sim_ALRR`);
            if (paused) {
                document.getElementById('paused-alert').classList.remove('hidden');
            }
            
            showScreen('home');
            
        } catch (error) {
            console.error("Erro ao carregar banco de dados:", error);
            document.getElementById('screen-home').classList.add('hidden');
            document.getElementById('screen-error').classList.remove('hidden');
            showLoadingState(false);
        }
    }

    function showLoadingState(show) {
        const moduleContainer = document.getElementById('module-container');
        if (show) {
            moduleContainer.innerHTML = '<div class="p-8 text-center text-slate-400"><div class="loader mx-auto mb-2"></div> Carregando módulos...</div>';
        }
    }

    function normalizeQuestion(q, id, topico, file, is2018File) {
        let mod = topico; // por padrão, o módulo é o tópico

        // Se for o arquivo de 2018, mudamos o módulo
        if (is2018File) {
            mod = "Questões de Concursos Anteriores (2018) - Regimento Interno";
        }

        let correctIdx = 0;
        if(q.resposta) {
            correctIdx = ['A','B','C','D','E'].indexOf(q.resposta.toUpperCase());
            if(correctIdx === -1) correctIdx = 0;
        }
        
        let options = [];
        if (Array.isArray(q.alternativas)) {
            options = q.alternativas;
        } else if (typeof q.alternativas === 'object' && q.alternativas !== null) {
            options = Object.values(q.alternativas);
        } else {
            options = ["Alternativa não disponível"];
        }
        
        return {
            id: id,
            module: mod,
            text: q.enunciado || q.question || "Questão sem enunciado",
            options: options,
            correct: correctIdx,
            explanation: q.explicacao || q.explanation || "Sem comentário disponível.",
            is2018: is2018File || (q.source === '2018') || (q.titulo && q.titulo.includes('2018'))
        };
    }

    function renderModules() {
        const modules = Object.keys(appState.moduleCounts).sort();
        const container = document.getElementById('module-container');
        container.innerHTML = '';
        
        modules.forEach(mod => {
            const count = appState.moduleCounts[mod];
            const is2018Module = mod.includes('2018');
            const label = document.createElement('label');
            label.className = "flex items-center justify-between p-2 hover:bg-slate-100 dark:hover:bg-slate-700/50 rounded transition group border-b border-transparent hover:border-slate-200 dark:hover:border-slate-600 cursor-pointer module-row";
            label.setAttribute('data-module', mod);
            label.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden flex-grow">
                    <input type="checkbox" value="${mod}" class="mod-chk w-4 h-4 text-brand-600 rounded focus:ring-brand-500 cursor-pointer transition" onchange="updateDistribution()" ${is2018Module ? 'data-2018="true"' : ''}>
                    <span class="tooltip">
                        <span class="text-xs md:text-sm truncate select-none dark:text-slate-300 font-medium truncate-with-tooltip" data-fulltext="${mod}" title="${mod}">${mod}</span>
                        <span class="tooltip-text">${mod}</span>
                    </span>
                </div>
                <div class="flex items-center gap-3">
                    <input type="number" min="0" max="${count}" class="manual-input hidden w-14 h-7 text-xs border border-slate-300 rounded px-1 text-center focus:border-brand-500 outline-none dark:bg-slate-800 dark:border-slate-600 dark:text-white" placeholder="0" oninput="updateDistribution()">
                    <span class="text-[10px] font-bold bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300 px-2 py-0.5 rounded-full min-w-[24px] text-center">${count}</span>
                </div>
            `;
            container.appendChild(label);
        });
        
        updateBadges();
    }

    function updateBadges() {
        const checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked'));
        document.getElementById('badge-modules').innerText = checkedModules.length;
        document.getElementById('badge-total').innerText = fullDatabase.length;
        
        const is2018 = document.getElementById('filter-2018').checked;
        let availableCount = 0;
        
        if (is2018) {
            availableCount = fullDatabase.filter(q => q.is2018).length;
        } else {
            const checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked')).map(c => c.value);
            availableCount = fullDatabase.filter(q => checkedModules.includes(q.module)).length;
        }
        
        document.getElementById('badge-available').innerText = availableCount;
    }

    function toggle2018Lock() {
        const isLocked = document.getElementById('filter-2018').checked;
        const moduleRows = document.querySelectorAll('.module-row');
        
        moduleRows.forEach(row => {
            const modName = row.getAttribute('data-module');
            const checkbox = row.querySelector('.mod-chk');
            const is2018Module = modName.includes('2018');
            
            if (isLocked) {
                if (is2018Module) {
                    checkbox.checked = true;
                    checkbox.disabled = false;
                    row.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    checkbox.checked = false;
                    checkbox.disabled = true;
                    row.classList.add('opacity-50', 'pointer-events-none');
                }
            } else {
                if (is2018Module) {
                    checkbox.checked = false;
                }
                checkbox.disabled = false;
                row.classList.remove('opacity-50', 'pointer-events-none');
            }
        });
        
        updateBadges();
        updateDistribution();
    }

    function toggleAllModules(val) {
        if(document.getElementById('filter-2018').checked) return;
        
        document.querySelectorAll('.mod-chk').forEach(c => {
            if (!c.disabled) {
                c.checked = val;
            }
        });
        
        updateBadges();
        updateDistribution();
    }

    function handleModeChange() {
        const mode = document.getElementById('distribution-mode').value;
        const qtyContainer = document.getElementById('qty-selector-container');
        
        if(mode === 'manual') {
            document.querySelectorAll('.manual-input').forEach(el => el.classList.remove('hidden'));
            qtyContainer.classList.add('opacity-50', 'pointer-events-none');
        } else {
            document.querySelectorAll('.manual-input').forEach(el => el.classList.add('hidden'));
            qtyContainer.classList.remove('opacity-50', 'pointer-events-none');
        }
        
        updateDistribution();
    }

    function setQuantity(val, evt) {
        document.querySelectorAll('.btn-qty').forEach(b => {
            b.classList.remove('bg-brand-50','border-brand-500','text-brand-700','dark:bg-brand-900/30','dark:text-brand-300');
            b.classList.add('border-slate-200','dark:border-slate-600');
        });
        
        if(val === 'custom') {
            const v = document.getElementById('custom-qty').value;
            appState.config.qty = parseInt(v) || 0;
        } else if(val === 'all') {
            appState.config.qty = 'all';
            if (evt) {
                evt.target.classList.add('bg-purple-50','border-purple-200','text-purple-700');
            }
        } else {
            appState.config.qty = val;
            document.getElementById('custom-qty').value = '';
            const btn = document.querySelector(`.btn-qty[data-val="${val}"]`);
            if(btn) btn.classList.add('bg-brand-50','border-brand-500','text-brand-700','dark:bg-brand-900/30','dark:text-brand-300');
        }
        
        updateDistribution();
    }

    function updateDistribution() {
        const is2018 = document.getElementById('filter-2018').checked;
        const mode = document.getElementById('distribution-mode').value;
        
        let availablePool = [];
        let checkedModules = [];
        
        if (is2018) {
            availablePool = fullDatabase.filter(q => q.is2018);
            checkedModules = ["Questões de Concursos Anteriores (2018)"];
        } else {
            checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked')).map(c => c.value);
            availablePool = fullDatabase.filter(q => checkedModules.includes(q.module));
        }

        document.getElementById('badge-modules').innerText = checkedModules.length;
        document.getElementById('badge-available').innerText = availablePool.length;

        appState.distribution = {};
        let totalPlan = 0;

        if (mode === 'manual') {
            document.querySelectorAll('.mod-chk:checked').forEach(cb => {
                const row = cb.closest('label');
                const input = row.querySelector('.manual-input');
                let val = parseInt(input.value) || 0;
                const realAvailable = fullDatabase.filter(q => q.module === cb.value && (!is2018 || q.is2018)).length;
                if(val > realAvailable) val = realAvailable;
                if(val > 0) {
                    appState.distribution[cb.value] = val;
                    totalPlan += val;
                }
            });
        } else {
            let targetQty = appState.config.qty === 'all' ? availablePool.length : appState.config.qty;
            if(targetQty > availablePool.length) targetQty = availablePool.length;
            totalPlan = targetQty;
            
            if(targetQty > 0 && availablePool.length > 0) {
                const moduleWeights = {};
                checkedModules.forEach(mod => {
                    moduleWeights[mod] = availablePool.filter(q => q.module === mod).length;
                });
                
                const totalWeight = Object.values(moduleWeights).reduce((a, b) => a + b, 0);
                
                if (mode === 'proportional' && totalWeight > 0) {
                    let remaining = targetQty;
                    Object.keys(moduleWeights).forEach(mod => {
                        const count = Math.round(moduleWeights[mod] / totalWeight * targetQty);
                        appState.distribution[mod] = Math.min(count, moduleWeights[mod]);
                        remaining -= appState.distribution[mod];
                    });
                    
                    if (remaining !== 0) {
                        const modules = Object.keys(moduleWeights);
                        for (let i = 0; i < Math.abs(remaining) && modules.length > 0; i++) {
                            const mod = modules[i % modules.length];
                            if (remaining > 0 && appState.distribution[mod] < moduleWeights[mod]) {
                                appState.distribution[mod]++;
                                remaining--;
                            } else if (remaining < 0 && appState.distribution[mod] > 0) {
                                appState.distribution[mod]--;
                                remaining++;
                            }
                        }
                    }
                } else if (mode === 'balanced') {
                    const modules = checkedModules.filter(mod => moduleWeights[mod] > 0);
                    const baseCount = Math.floor(targetQty / modules.length);
                    let remainder = targetQty % modules.length;
                    
                    modules.forEach(mod => {
                        let count = baseCount;
                        if (remainder > 0 && moduleWeights[mod] >= baseCount + 1) {
                            count++;
                            remainder--;
                        }
                        appState.distribution[mod] = Math.min(count, moduleWeights[mod]);
                    });
                    
                    if (remainder > 0) {
                        for (let mod of modules) {
                            if (remainder <= 0) break;
                            if (appState.distribution[mod] < moduleWeights[mod]) {
                                appState.distribution[mod]++;
                                remainder--;
                            }
                        }
                    }
                }
            }
        }

        document.getElementById('badge-target').innerText = totalPlan;

        const previewList = document.getElementById('distribution-preview');
        previewList.innerHTML = '';
        
        if (availablePool.length === 0) {
            previewList.innerHTML = `<p class="text-slate-400 italic">Nenhuma questão disponível.</p>`;
            document.getElementById('preview-total').innerText = "0 questões";
        } else {
             if(mode === 'manual') {
                let displayTotal = 0;
                for (const [mod, qtd] of Object.entries(appState.distribution)) {
                    displayTotal += qtd;
                    previewList.innerHTML += `<div class="flex justify-between border-b border-slate-100 dark:border-slate-600 pb-1">
                        <span class="truncate pr-2 truncate-with-tooltip" data-fulltext="${mod}" title="${mod}">${mod}</span>
                        <span class="font-bold text-brand-600">${qtd}</span>
                    </div>`;
                }
                document.getElementById('preview-total').innerText = `${displayTotal} questões`;
             } else {
                 if (mode === 'random') {
                     document.getElementById('preview-total').innerText = `${totalPlan} questões (Sorteio Aleatório)`;
                     previewList.innerHTML = `<p class="text-brand-600 font-bold">Serão sorteadas ${totalPlan} questões do universo de ${availablePool.length} disponíveis.</p>`;
                 } else {
                     let previewHTML = `<p class="text-brand-600 font-bold">Distribuição planejada (${totalPlan} questões):</p>`;
                     for (const [mod, qtd] of Object.entries(appState.distribution)) {
                         previewHTML += `<div class="flex justify-between border-b border-slate-100 dark:border-slate-600 pb-1 mt-1">
                             <span class="truncate pr-2 truncate-with-tooltip" data-fulltext="${mod}" title="${mod}">${mod}</span>
                             <span class="font-bold text-brand-600">${qtd}</span>
                         </div>`;
                     }
                     previewList.innerHTML = previewHTML;
                 }
             }
        }
    }

    function startSimulation() {
        console.log("Iniciando simulação...");
        const mode = document.getElementById('distribution-mode').value;
        const is2018 = document.getElementById('filter-2018').checked;
        
        let checkedModules = [];
        let pool = [];
        
        if (is2018) {
            pool = fullDatabase.filter(q => q.is2018);
            checkedModules = ["Questões de Concursos Anteriores (2018)"];
        } else {
            checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked')).map(c => c.value);
            if(checkedModules.length === 0) {
                alert("Selecione pelo menos um módulo.");
                return;
            }
            pool = fullDatabase.filter(q => checkedModules.includes(q.module));
        }

        let reqQty = 0;
        if(mode === 'manual') {
             for(let k in appState.distribution) reqQty += appState.distribution[k];
        } else {
             reqQty = appState.config.qty === 'all' ? pool.length : appState.config.qty;
        }

        if(pool.length === 0) {
            alert("Sem questões disponíveis para os critérios selecionados.");
            return;
        }
        
        if(reqQty > pool.length && mode !== 'manual') {
            document.getElementById('warning-modal').classList.remove('hidden');
            return;
        }

        let finalQuestions = [];
        
        if (mode === 'manual') {
            for (const [mod, qtd] of Object.entries(appState.distribution)) {
                const modPool = pool.filter(q => q.module === mod);
                const shuffled = [...modPool].sort(() => Math.random() - 0.5);
                finalQuestions.push(...shuffled.slice(0, qtd));
            }
        } else {
            if(mode === 'random') {
                const shuffled = [...pool].sort(() => Math.random() - 0.5);
                finalQuestions = shuffled.slice(0, reqQty);
            } else if (mode === 'balanced' || mode === 'proportional') {
                for (const [mod, qtd] of Object.entries(appState.distribution)) {
                    const modPool = pool.filter(q => q.module === mod);
                    const shuffled = [...modPool].sort(() => Math.random() - 0.5);
                    finalQuestions.push(...shuffled.slice(0, qtd));
                }
            }
        }

        finalQuestions = finalQuestions.sort(() => Math.random() - 0.5);
        
        if(finalQuestions.length === 0) {
            alert("Erro na geração do simulado. Nenhuma questão foi selecionada.");
            return;
        }
        
        appState.questions = finalQuestions;
        appState.answers = new Array(finalQuestions.length).fill(null).map(() => ({ sel: null, ok: false, isCorrect: false }));
        appState.index = 0;
        appState.startTime = new Date();
        appState.isPaused = false;
        
        startTimer();
        loadQuestion(0);
        renderNav();
        showScreen('quiz');
    }

    function loadPdfForModule(moduleName) {
        let pdfPath = '';
        let pdfTitle = 'Documento de Apoio';
        
        if (moduleName.includes('Regimento Interno')) {
            pdfPath = topicos['Regimento Interno ALE-RR 2023'].pdf;
            pdfTitle = 'Regimento Interno ALE-RR 2023';
        } else if (moduleName.includes('Lei Complementar 53')) {
            pdfPath = topicos['Lei Complementar 53/2001'].pdf;
            pdfTitle = 'Lei Complementar 53/2001';
        } else if (moduleName.includes('Constituição Estadual')) {
            pdfPath = topicos['Constituição Estadual de Roraima'].pdf;
            pdfTitle = 'Constituição Estadual de Roraima';
        } else {
            // Documento padrão
            pdfPath = topicos['Regimento Interno ALE-RR 2023'].pdf;
            pdfTitle = 'Documento de Apoio';
        }
        
        document.getElementById('pdf-title').textContent = pdfTitle;
        document.getElementById('pdf-viewer').data = pdfPath;
        document.getElementById('pdf-external-link').href = pdfPath;
        document.getElementById('pdf-download-link').href = pdfPath;
    }

    function loadQuestion(idx) {
        if (idx < 0 || idx >= appState.questions.length) return;
        
        appState.index = idx;
        const q = appState.questions[idx];
        const ans = appState.answers[idx];
        
        document.getElementById('q-current-index').innerText = idx + 1;
        document.getElementById('q-total-count').innerText = appState.questions.length;
        
        const moduleNameEl = document.getElementById('q-module-name');
        const moduleNameTooltipEl = document.getElementById('q-module-name-tooltip');
        const moduleName = q.module;
        const truncatedModuleName = moduleName.length > 30 ? moduleName.substring(0, 30) + '...' : moduleName;
        
        moduleNameEl.textContent = truncatedModuleName;
        moduleNameEl.setAttribute('data-fulltext', moduleName);
        moduleNameTooltipEl.textContent = moduleName;
        
        // Carregar o PDF correspondente ao módulo
        loadPdfForModule(moduleName);
        
        document.getElementById('q-text').innerText = q.text;
        document.getElementById('progress-bar').style.width = `${((idx+1)/appState.questions.length)*100}%`;
        
        const divOpts = document.getElementById('options-container');
        divOpts.innerHTML = '';
        
        const letters = ['A','B','C','D','E'];
        q.options.forEach((opt, i) => {
            const el = document.createElement('div');
            let cls = "option-card w-full p-4 rounded-xl flex items-start cursor-pointer border-2 bg-white dark:bg-slate-700 border-slate-100 dark:border-slate-600";
            
            if(ans.ok) {
                el.classList.add('cursor-default','disabled');
                if(i === q.correct) {
                    cls += " correct";
                } else if(i === ans.sel) {
                    cls += " wrong";
                } else {
                    cls += " opacity-40";
                }
            } else {
                if(ans.sel === i) cls += " selected"; 
                el.onclick = () => selectOpt(i);
            }
            
            el.className = cls;
            el.innerHTML = `
                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold mr-4 shrink-0 transition ${
                    ans.sel === i ? 'bg-brand-500 border-brand-500 text-white' : 'border-slate-300 text-slate-400'
                }">${letters[i]}</div>
                <div class="text-slate-700 dark:text-slate-200 pt-1 text-sm md:text-base">${opt}</div>
            `;
            divOpts.appendChild(el);
        });
        
        const btnConf = document.getElementById('btn-confirm');
        const boxExp = document.getElementById('explanation-box');
        
        if(ans.ok) { 
            btnConf.classList.add('hidden'); 
            boxExp.classList.remove('hidden'); 
            document.getElementById('explanation-text').innerText = q.explanation; 
        } else { 
            btnConf.classList.remove('hidden'); 
            btnConf.disabled = (ans.sel === null); 
            boxExp.classList.add('hidden'); 
        }
        
        const btnNext = document.getElementById('btn-next');
        if(idx === appState.questions.length - 1) { 
            btnNext.innerText = "Finalizar"; 
            btnNext.className = "bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-6 py-2 rounded-lg font-bold transition mobile-full";
            btnNext.onclick = finishSimulation; 
        } else { 
            btnNext.onclick = () => changeQuestion(1); 

            if(ans.ok) {
                btnNext.innerHTML = 'Próxima <i class="fas fa-arrow-right ml-2"></i>';
                btnNext.className = "bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-lg font-bold transition mobile-full shadow-md";
            } else {
                btnNext.innerText = "Pular";
                btnNext.className = "bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white px-6 py-2 rounded-lg font-bold transition mobile-full";
            }
        }
        
        document.getElementById('btn-prev').disabled = idx === 0;
        document.querySelectorAll('.nav-dot').forEach((d, i) => {
            d.classList.toggle('ring-2', i === idx);
            d.classList.toggle('ring-brand-500', i === idx);
        });
        
        toggleSection('explanation');
        
        updateQuestionStats();
    }
    
    function selectOpt(i) { 
        appState.answers[appState.index].sel = i; 
        loadQuestion(appState.index); 
    }
    
    function confirmAnswer() {
        const idx = appState.index; 
        if(appState.answers[idx].sel === null) return;
        
        const isCorrect = (appState.answers[idx].sel === appState.questions[idx].correct);
        appState.answers[idx].ok = true; 
        appState.answers[idx].isCorrect = isCorrect;
        
        loadQuestion(idx); 
        renderNav();
    }
    
    function changeQuestion(d) { 
        const n = appState.index + d; 
        if(n >= 0 && n < appState.questions.length) loadQuestion(n); 
    }
    
    function renderNav() {
        const g = document.getElementById('nav-grid'); 
        g.innerHTML = '';
        
        appState.answers.forEach((a, i) => {
            const d = document.createElement('div');
            let cls = "nav-dot w-full aspect-square rounded flex items-center justify-center text-xs font-bold cursor-pointer transition ";
            
            if(a.ok) {
                cls += a.isCorrect ? "bg-green-500 text-white" : "bg-red-500 text-white";
            } else {
                cls += "bg-slate-200 dark:bg-slate-600 text-slate-500";
            }
            
            if(i === appState.index) {
                cls += " ring-2 ring-brand-500 ring-offset-2 dark:ring-offset-slate-800";
            }
            
            d.className = cls; 
            d.innerText = i + 1; 
            d.onclick = () => loadQuestion(i); 
            g.appendChild(d);
        });
    }
    
    function startTimer() {
        appState.startTime = new Date();
        if(appState.timer) clearInterval(appState.timer);
        
        appState.timer = setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - appState.startTime) / 1000);
            const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${minutes}:${seconds}`;
        }, 1000);
    }
    
    function calculateModuleStats() {
        const moduleStats = {};
        appState.questions.forEach((q, idx) => {
            const mod = q.module;
            if (!moduleStats[mod]) {
                moduleStats[mod] = { correct: 0, wrong: 0, unanswered: 0, total: 0 };
            }
            moduleStats[mod].total++;
            const ans = appState.answers[idx];
            if (!ans.ok) {
                moduleStats[mod].unanswered++;
            } else if (ans.isCorrect) {
                moduleStats[mod].correct++;
            } else {
                moduleStats[mod].wrong++;
            }
        });
        return moduleStats;
    }
    
    function finishSimulation() {
        if (appState.timer) {
            clearInterval(appState.timer);
            appState.timer = null;
        }
        
        let correct = 0, wrong = 0, unanswered = 0;
        appState.answers.forEach((a, i) => { 
            if(!a.ok) {
                unanswered++; 
            } else if(a.isCorrect) {
                correct++; 
            } else {
                wrong++; 
            }
        });
        
        const total = appState.questions.length; 
        const percent = total > 0 ? Math.round((correct/total)*100) : 0;
        const moduleStats = calculateModuleStats();
        const duration = appState.startTime ? Math.floor((new Date() - appState.startTime) / 1000) : 0;
        
        document.getElementById('res-correct').innerText = correct; 
        document.getElementById('res-wrong').innerText = wrong;
        document.getElementById('res-unanswered').innerText = unanswered; 
        document.getElementById('res-percent').innerText = `${percent}%`;
        
        // Atualizar estatísticas por módulo na tela de resultados
        const modulePerformance = document.getElementById('module-performance');
        modulePerformance.innerHTML = '';
        
        for (const [mod, stats] of Object.entries(moduleStats)) {
            const modulePercent = stats.total > 0 ? Math.round((stats.correct/stats.total)*100) : 0;
            const moduleEl = document.createElement('div');
            moduleEl.className = 'bg-slate-50 dark:bg-slate-700/50 rounded-xl p-4 border border-slate-200 dark:border-slate-600';
            moduleEl.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h5 class="font-bold text-slate-700 dark:text-slate-200 truncate">${mod}</h5>
                    <span class="text-lg font-bold ${modulePercent >= 70 ? 'text-green-600' : modulePercent >= 50 ? 'text-yellow-600' : 'text-red-600'}">${modulePercent}%</span>
                </div>
                <div class="flex justify-between text-sm text-slate-600 dark:text-slate-400">
                    <span>${stats.correct} acertos</span>
                    <span>${stats.wrong} erros</span>
                    <span>${stats.unanswered} brancos</span>
                    <span>${stats.total} total</span>
                </div>
            `;
            modulePerformance.appendChild(moduleEl);
        }
        
        const ctx = document.getElementById('resultChart').getContext('2d'); 
        if(resultChartInstance) resultChartInstance.destroy();
        
        resultChartInstance = new Chart(ctx, { 
            type: 'doughnut', 
            data: { 
                labels: ['Acertos','Erros','Branco'], 
                datasets: [{
                    data: [correct, wrong, unanswered], 
                    backgroundColor: ['#16a34a', '#dc2626', '#94a3b8'], 
                    borderWidth: 0
                }] 
            }, 
            options: { 
                cutout: '75%', 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false } 
                } 
            } 
        });
        
        if(appState.savingEnabled) {
            saveHistory({ 
                date: new Date(), 
                correct: correct, 
                wrong: wrong, 
                unanswered: unanswered,
                total: total,
                percent: percent,
                duration: duration,
                modules: moduleStats
            }); 
        }
        
        localStorage.removeItem(`alerr_paused_sim_ALRR`);
        
        showScreen('result');
    }
    
    function saveHistory(data) { 
        const key = `alerr_hist_ALRR`;
        const h = JSON.parse(localStorage.getItem(key) || '[]'); 
        data.correct = Number(data.correct) || 0;
        data.wrong = Number(data.wrong) || 0;
        data.unanswered = Number(data.unanswered) || 0;
        data.total = Number(data.total) || 0;
        data.percent = Number(data.percent) || 0;
        data.duration = Number(data.duration) || 0;
        data.modules = data.modules || {};
        
        h.unshift(data); 
        if (h.length > 100) h.length = 100;
        localStorage.setItem(key, JSON.stringify(h)); 
        updateCacheStats();
    }

    // ============================================
    // FUNÇÕES AUXILIARES E DE INTERFACE
    // ============================================

    function showScreen(id) { 
        ['home','quiz','result','analytics','error','pause'].forEach(s => {
            const screen = document.getElementById('screen-'+s);
            if (screen) screen.classList.add('hidden');
        }); 
        
        const targetScreen = document.getElementById('screen-'+id);
        if (targetScreen) {
            targetScreen.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        if(id === 'home') {
            updateDistribution();
            const paused = localStorage.getItem(`alerr_paused_sim_ALRR`);
            if (paused) {
                document.getElementById('paused-alert').classList.remove('hidden');
            }
        } else if (id === 'analytics') {
            setTimeout(() => {
                loadHistory();
            }, 100);
        } else if (id === 'quiz') {
            toggleSection('explanation');
        }
    }
    
    function togglePdfDrawer() { 
        const d = document.getElementById('pdf-drawer'); 
        d.classList.toggle('translate-x-full'); 
        d.classList.toggle('drawer-open'); 
    }
    
    function initTheme() { 
        if(localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
        updateThemeIcon();
    }
    
    function toggleDarkMode() { 
        document.documentElement.classList.toggle('dark'); 
        localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
        updateThemeIcon();
    }

    function updateThemeIcon() {
        const themeIcon = document.getElementById('theme-icon');
        if (document.documentElement.classList.contains('dark')) {
            themeIcon.className = 'fas fa-sun';
        } else {
            themeIcon.className = 'fas fa-moon';
        }
    }

    function pauseSimulation() {
        const now = new Date();
        const elapsed = Math.floor((now - appState.startTime) / 1000);

        const pausedState = {
            questions: appState.questions,
            answers: appState.answers,
            index: appState.index,
            config: appState.config,
            elapsedTime: elapsed,
            datePaused: new Date().toISOString()
        };

        localStorage.setItem(`alerr_paused_sim_ALRR`, JSON.stringify(pausedState));

        if (appState.timer) {
            clearInterval(appState.timer);
            appState.timer = null;
        }

        updatePauseScreen(pausedState);

        appState.isPaused = true;

        showScreen('pause');
    }

    function updatePauseScreen(pausedState) {
        const total = pausedState.questions.length;
        const current = pausedState.index + 1;
        document.getElementById('paused-progress').textContent = `${current}/${total}`;

        let correct = 0;
        for (let i = 0; i < pausedState.answers.length; i++) {
            if (pausedState.answers[i].ok && pausedState.answers[i].isCorrect) {
                correct++;
            }
        }
        document.getElementById('paused-correct').textContent = correct;

        const minutes = Math.floor(pausedState.elapsedTime / 60).toString().padStart(2, '0');
        const seconds = (pausedState.elapsedTime % 60).toString().padStart(2, '0');
        document.getElementById('paused-time').textContent = `${minutes}:${seconds}`;
    }

    function resumeSimulation() {
        const paused = localStorage.getItem(`alerr_paused_sim_ALRR`);
        
        if (!paused) {
            alert('Não há simulado pausado.');
            return;
        }

        const state = JSON.parse(paused);

        appState.questions = state.questions;
        appState.answers = state.answers;
        appState.index = state.index;
        appState.config = state.config;

        const now = new Date();
        const adjustedStartTime = new Date(now.getTime() - (state.elapsedTime * 1000));
        appState.startTime = adjustedStartTime;

        localStorage.removeItem(`alerr_paused_sim_ALRR`);

        document.getElementById('paused-alert').classList.add('hidden');

        startTimer();

        loadQuestion(appState.index);
        renderNav();

        showScreen('quiz');
    }

    function discardPaused() {
        if (confirm('Tem certeza que deseja descartar o simulado pausado? Esta ação não pode ser desfeita.')) {
            localStorage.removeItem(`alerr_paused_sim_ALRR`);
            document.getElementById('paused-alert').classList.add('hidden');
        }
    }

    function abandonSimulation() {
        if (!confirm('Tem certeza que deseja abandonar o simulado? Todo o progresso será perdido e não será salvo no histórico.')) {
            return;
        }

        if (appState.timer) {
            clearInterval(appState.timer);
            appState.timer = null;
        }

        localStorage.removeItem(`alerr_paused_sim_ALRR`);

        appState.questions = [];
        appState.answers = [];
        appState.index = 0;
        appState.isPaused = false;

        showScreen('home');
    }

    function toggleCacheModal() {
        const m = document.getElementById('cache-modal');
        m.classList.toggle('hidden');
        updateCacheStats();
    }
    
    function updateCacheStats() {
        let used = 0;
        for(let x in localStorage) { 
            if(localStorage.hasOwnProperty(x)) {
                used += (localStorage[x].length + x.length) * 2; 
            }
        }
        const kb = (used / 1024).toFixed(2);
        document.getElementById('cache-usage-text').innerText = `${kb} KB`;
        
        const footerBadge = document.getElementById('footer-cache-stat');
        if (footerBadge) footerBadge.innerText = `${kb} KB`;

        const percent = Math.min((used/5000000)*100, 100);
        document.getElementById('cache-bar').style.width = `${percent}%`;
    }
    
    function toggleHistorySaving() {
        appState.savingEnabled = document.getElementById('toggle-save-history').checked;
        localStorage.setItem('alerr_save_pref', appState.savingEnabled);
        updateCacheStats();
    }
    
    function clearHistory(scope) {
        if(!confirm("Tem certeza que deseja limpar o histórico?")) return;
        
        if(scope === 'all') { 
            localStorage.removeItem('alerr_hist_ALRR');
            localStorage.removeItem('alerr_fullDatabase_ALRR');
            localStorage.removeItem('alerr_cacheTimestamp_ALRR');
            localStorage.removeItem('alerr_paused_sim_ALRR');
            
            loadHistory(); 
            updateCacheStats(); 
            toggleCacheModal();
            return; 
        }
        
        const key = `alerr_hist_ALRR`;
        let h = JSON.parse(localStorage.getItem(key) || '[]');
        const now = new Date().getTime();
        let cutoff = 0;

        if(scope === '1h') cutoff = now - (1 * 60 * 60 * 1000);
        else if(scope === '2h') cutoff = now - (2 * 60 * 60 * 1000);
        else if(scope === '4h') cutoff = now - (4 * 60 * 60 * 1000);
        else if(scope === '24h') cutoff = now - (24 * 60 * 60 * 1000);
        else if(scope === 'week') cutoff = now - (7 * 24 * 60 * 60 * 1000);
        else if(scope === 'month') cutoff = now - (30 * 24 * 60 * 60 * 1000);
        else if(scope === 'custom') {
            const dateVal = document.getElementById('custom-date-clear').value;
            if(!dateVal) return alert("Selecione uma data.");
            cutoff = new Date(dateVal).getTime();
        }

        h = h.filter(x => new Date(x.date).getTime() >= cutoff);
        localStorage.setItem(key, JSON.stringify(h));
        loadHistory(); 
        updateCacheStats();
        toggleCacheModal();
    }

    function loadHistory(filters = { days: 'all', module: 'all' }) {
        const key = `alerr_hist_ALRR`;
        let allHistory = JSON.parse(localStorage.getItem(key) || '[]');
        
        if(filters.days !== 'all') { 
            const limit = new Date(); 
            limit.setDate(limit.getDate() - filters.days); 
            allHistory = allHistory.filter(x => new Date(x.date) >= limit); 
        }
        
        if(filters.module !== 'all') {
            allHistory = allHistory.filter(item => item.modules && item.modules[filters.module]);
        }

        document.getElementById('history-table-body').innerHTML = '';
        
        if(allHistory.length === 0) {
            document.getElementById('history-table-body').innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500 dark:text-slate-400">Nenhum registro encontrado.</td></tr>';
        } else {
            allHistory.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50';
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString('pt-BR');
                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                row.innerHTML = `
                    <td class="px-4 py-3">${dateStr} ${timeStr}</td>
                    <td class="px-4 py-3 font-bold text-green-600">${item.correct}</td>
                    <td class="px-4 py-3 font-bold text-red-600">${item.wrong}</td>
                    <td class="px-4 py-3 font-bold text-slate-400">${item.unanswered}</td>
                    <td class="px-4 py-3 font-bold ${item.percent >= 70 ? 'text-green-600' : item.percent >= 50 ? 'text-yellow-600' : 'text-red-600'}">${item.percent}%</td>
                    <td class="px-4 py-3">${formatTime(item.duration)}</td>
                    <td class="px-4 py-3">${Object.keys(item.modules || {}).length} módulos</td>
                `;
                document.getElementById('history-table-body').appendChild(row);
            });
        }
        
        updateMetricsCards(allHistory);
        renderHistoryChart(allHistory);
        renderDistributionChart(allHistory);
        renderTrendChart(allHistory);
    }
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function renderHistoryChart(historyData) {
        const ctx = document.getElementById('historyChart').getContext('2d');
        if(historyChartInstance) historyChartInstance.destroy();
        
        const dates = historyData.slice(-10).map(item => {
            const d = new Date(item.date);
            return `${d.getDate()}/${d.getMonth()+1}`;
        });
        const percents = historyData.slice(-10).map(item => item.percent);
        
        historyChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Desempenho (%)',
                    data: percents,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    function renderDistributionChart(historyData) {
        const ctx = document.getElementById('distributionChart').getContext('2d');
        if(distributionChartInstance) distributionChartInstance.destroy();
        
        const moduleMap = {};
        historyData.forEach(item => {
            Object.keys(item.modules || {}).forEach(mod => {
                if(!moduleMap[mod]) moduleMap[mod] = { correct: 0, total: 0 };
                moduleMap[mod].correct += item.modules[mod].correct;
                moduleMap[mod].total += item.modules[mod].total;
            });
        });
        
        const labels = Object.keys(moduleMap).slice(0, 5);
        const data = labels.map(mod => {
            const percent = moduleMap[mod].total > 0 ? (moduleMap[mod].correct / moduleMap[mod].total * 100) : 0;
            return Math.round(percent);
        });
        
        distributionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Acerto por módulo (%)',
                    data: data,
                    backgroundColor: labels.map((_, i) => 
                        ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'][i % 5]
                    ),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { maxRotation: 45 }
                    }
                }
            }
        });
    }
    
    function renderTrendChart(historyData) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if(trendChartInstance) trendChartInstance.destroy();
        
        const movingAvg = [];
        const windowSize = 5;
        
        for(let i = 0; i < historyData.length; i++) {
            const start = Math.max(0, i - windowSize + 1);
            const slice = historyData.slice(start, i + 1);
            const avg = slice.reduce((sum, item) => sum + item.percent, 0) / slice.length;
            movingAvg.push(avg);
        }
        
        const labels = historyData.map((_, i) => i + 1);
        
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Média móvel (5 simulados)',
                    data: movingAvg,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: { 
                        grid: { display: false },
                        title: { display: true, text: 'Número do simulado' }
                    }
                }
            }
        });
    }

    function updateMetricsCards(historyData = []) {
        if(historyData.length === 0) {
            const key = `alerr_hist_ALRR`;
            historyData = JSON.parse(localStorage.getItem(key) || '[]');
        }
        
        document.getElementById('metric-total-simulations').textContent = historyData.length;
        
        if(historyData.length > 0) {
            const bestScore = Math.max(...historyData.map(item => item.percent));
            document.getElementById('metric-best-score').textContent = `${Math.round(bestScore)}%`;
            
            const avgTime = historyData.reduce((sum, item) => sum + item.duration, 0) / historyData.length;
            const avgTimePerQuestion = avgTime > 0 ? Math.round(avgTime / (historyData[0].total || 1)) : 0;
            document.getElementById('metric-avg-time').textContent = `${avgTimePerQuestion}s`;
            
            // Calcular evolução (últimos 5 vs anteriores)
            if(historyData.length >= 10) {
                const last5 = historyData.slice(0, 5);
                const prev5 = historyData.slice(5, 10);
                
                const avgLast5 = last5.reduce((sum, item) => sum + item.percent, 0) / last5.length;
                const avgPrev5 = prev5.reduce((sum, item) => sum + item.percent, 0) / prev5.length;
                
                const evolution = ((avgLast5 - avgPrev5) / avgPrev5 * 100).toFixed(1);
                
                const evolutionBadges = document.querySelectorAll('.evolution-badge');
                if(evolution > 0) {
                    evolutionBadges[1].className = 'evolution-badge evolution-positive';
                    evolutionBadges[1].textContent = `+${evolution}%`;
                } else if(evolution < 0) {
                    evolutionBadges[1].className = 'evolution-badge evolution-negative';
                    evolutionBadges[1].textContent = `${evolution}%`;
                } else {
                    evolutionBadges[1].className = 'evolution-badge evolution-neutral';
                    evolutionBadges[1].textContent = '0%';
                }
            }
        }
    }

    function setHistoryFilter(type, value) {
        historyFilters[type] = value;
        loadHistory(historyFilters);
        updateFilterButtons();
    }

    function updateFilterButtons() {
        const days = historyFilters.days;
        ['all','1','7','30'].forEach(f => { 
            const btn = document.getElementById(`hist-filter-${f}`);
            if (btn) {
                if (f == days) {
                    btn.className = "px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700";
                } else {
                    btn.className = "px-3 py-1 text-xs font-bold rounded text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700";
                }
            }
        });
    }

    function exportHistoryCSV() {
        const key = `alerr_hist_ALRR`;
        const history = JSON.parse(localStorage.getItem(key) || '[]');
        
        if(history.length === 0) {
            alert("Não há dados para exportar.");
            return;
        }
        
        let csv = 'Data,Acertos,Erros,Branco,Total,Percentual,Tempo(s),Módulos\n';
        
        history.forEach(item => {
            const date = new Date(item.date).toISOString();
            const modules = Object.keys(item.modules || {}).join(';');
            csv += `"${date}",${item.correct},${item.wrong},${item.unanswered},${item.total},${item.percent},${item.duration},"${modules}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `historico_alerr_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    
    function importHistoryCSV() {
        document.getElementById('csv-import-modal').classList.remove('hidden');
    }
    
    function closeCSVImportModal() {
        document.getElementById('csv-import-modal').classList.add('hidden');
        document.getElementById('csv-file-input').value = '';
    }
    
    function processCSVImport() {
        const fileInput = document.getElementById('csv-file-input');
        if(!fileInput.files.length) {
            alert('Selecione um arquivo CSV.');
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',');
                
                const importedHistory = [];
                
                for(let i = 1; i < lines.length; i++) {
                    if(!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',');
                    const item = {
                        date: new Date(values[0].replace(/"/g, '')),
                        correct: parseInt(values[1]),
                        wrong: parseInt(values[2]),
                        unanswered: parseInt(values[3]),
                        total: parseInt(values[4]),
                        percent: parseFloat(values[5]),
                        duration: parseInt(values[6]),
                        modules: {}
                    };
                    
                    if(values[7]) {
                        const modules = values[7].replace(/"/g, '').split(';');
                        modules.forEach(mod => {
                            if(mod.trim()) {
                                item.modules[mod] = { correct: 0, wrong: 0, unanswered: 0, total: 0 };
                            }
                        });
                    }
                    
                    importedHistory.push(item);
                }
                
                localStorage.setItem(`alerr_hist_ALRR`, JSON.stringify(importedHistory));
                alert(`Importação concluída! ${importedHistory.length} registros importados.`);
                closeCSVImportModal();
                loadHistory();
                
            } catch(error) {
                console.error('Erro ao importar CSV:', error);
                alert('Erro ao processar o arquivo CSV. Verifique o formato.');
            }
        };
        
        reader.readAsText(file);
    }

    // ============================================
    // FUNÇÕES PARA COMENTÁRIOS E REPORTAR
    // ============================================

    function showReportModal() {
        document.getElementById('report-modal').classList.remove('hidden');
    }

    function closeReportModal() {
        document.getElementById('report-modal').classList.add('hidden');
        document.getElementById('report-type').value = 'erro';
        document.getElementById('report-description').value = '';
    }

    function submitReport() {
        const type = document.getElementById('report-type').value;
        const description = document.getElementById('report-description').value;
        
        if (!description.trim()) {
            alert('Por favor, descreva o problema encontrado.');
            return;
        }
        
        console.log('Reporte enviado:', { type, description, questionId: appState.index });
        
        alert('Obrigado por reportar o problema! Nossa equipe irá analisá-lo.');
        closeReportModal();
    }

    let emojiPickerOpen = false;

    function toggleEmojiPicker() {
        const picker = document.getElementById('emoji-picker');
        picker.classList.toggle('hidden');
        emojiPickerOpen = !picker.classList.contains('hidden');
        
        if (emojiPickerOpen) {
            const emojis = ['😀', '😂', '🥰', '😎', '🤔', '👏', '🙌', '🔥', '💯', '👍', '👎', '❤️', '🎉', '🤝', '💪', '✨', '🌟', '💡', '📚', '🎯'];
            
            picker.innerHTML = '';
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji-option';
                span.textContent = emoji;
                span.onclick = () => {
                    const editor = document.getElementById('new-comment-editor');
                    insertTextAtCursor(editor, emoji);
                    editor.focus();
                };
                picker.appendChild(span);
            });
        }
    }

    function insertTextAtCursor(element, text) {
        const range = document.getSelection().getRangeAt(0);
        range.deleteContents();
        const textNode = document.createTextNode(text);
        range.insertNode(textNode);
        range.setStartAfter(textNode);
        range.setEndAfter(textNode);
        document.getSelection().removeAllRanges();
        document.getSelection().addRange(range);
    }

    function formatText(command, value = null) {
        document.execCommand(command, false, value);
        document.getElementById('new-comment-editor').focus();
    }

    // Fechar emoji picker ao clicar fora
    document.addEventListener('click', function(event) {
        const picker = document.getElementById('emoji-picker');
        const emojiButton = document.querySelector('button[onclick="toggleEmojiPicker()"]');
        
        if (picker && !picker.contains(event.target) && event.target !== emojiButton && !emojiButton.contains(event.target)) {
            picker.classList.add('hidden');
            emojiPickerOpen = false;
        }
    });

    function addComment() {
        const editor = document.getElementById('new-comment-editor');
        const commentText = editor.innerHTML.trim();
        
        if (!commentText || commentText === '<br>') {
            alert('Por favor, escreva um comentário antes de enviar.');
            return;
        }
        
        const commentsList = document.getElementById('comments-list');
        const newComment = document.createElement('div');
        newComment.className = 'comment-item';
        const commentId = 'comment_' + Date.now() + Math.random().toString(36).substr(2, 9);
        newComment.dataset.commentId = commentId;
        
        const avatars = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-yellow-500'];
        const randomAvatar = avatars[Math.floor(Math.random() * avatars.length)];
        
        newComment.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="comment-avatar ${randomAvatar}">U</div>
                <div class="flex-1">
                    <div class="flex justify-between items-start">
                        <div>
                            <h5 class="font-bold text-slate-800 dark:text-white">Você</h5>
                            <div class="comment-date">Agora</div>
                        </div>
                        <button onclick="reportComment(this)" class="text-xs text-red-500 hover:text-red-700 dark:hover:text-red-400">
                            Reportar abuso
                        </button>
                    </div>
                    <div class="mt-2 text-slate-700 dark:text-slate-300 comment-content">${commentText}</div>
                    <div class="comment-actions">
                        <button onclick="likeComment(this)">
                            <i class="far fa-thumbs-up"></i>
                            <span>Gostei (<span class="like-count">0</span>)</span>
                        </button>
                        <button onclick="toggleResponses(this)">
                            <i class="far fa-comment"></i>
                            <span>Respostas (<span class="response-count">0</span>)</span>
                        </button>
                    </div>
                    <div class="comment-responses hidden mt-4">
                        <!-- Respostas serão carregadas aqui -->
                    </div>
                </div>
            </div>
        `;
        
        commentsList.insertBefore(newComment, commentsList.firstChild);
        
        const commentCount = parseInt(document.getElementById('comments-count')?.textContent) || 0;
        const commentsCountEl = document.getElementById('comments-count');
        if (commentsCountEl) {
            commentsCountEl.textContent = `${commentCount + 1} comentários`;
        }
        
        editor.innerHTML = '';
        document.getElementById('emoji-picker').classList.add('hidden');
        emojiPickerOpen = false;
        
        console.log('Comentário adicionado:', commentText);
    }

    function loadMoreComments() {
        alert('Funcionalidade de carregar mais comentários será implementada com o back-end.');
    }

    function reportComment(button) {
        const commentDiv = button.closest('.comment-item');
        const commentAuthor = commentDiv.querySelector('h5').textContent;
        const commentId = commentDiv.dataset.commentId;
        
        // Armazenar o comentário atual para reporte
        window.currentReportedComment = commentId;
        
        // Mostrar modal de reporte de comentário
        document.getElementById('report-comment-modal').classList.remove('hidden');
    }

    function closeReportCommentModal() {
        document.getElementById('report-comment-modal').classList.add('hidden');
        document.getElementById('report-comment-type').value = 'spam';
        document.getElementById('report-comment-description').value = '';
        window.currentReportedComment = null;
    }

    function submitCommentReport() {
        const type = document.getElementById('report-comment-type').value;
        const description = document.getElementById('report-comment-description').value;
        const commentId = window.currentReportedComment;
        
        if (!description.trim()) {
            alert('Por favor, descreva o motivo do reporte.');
            return;
        }
        
        console.log('Reporte de comentário enviado:', { type, description, commentId });
        
        // Marcar o comentário como reportado visualmente
        if (commentId) {
            const commentDiv = document.querySelector(`[data-comment-id="${commentId}"]`);
            if (commentDiv) {
                commentDiv.style.opacity = '0.7';
                commentDiv.style.backgroundColor = '#fef2f2';
                if (document.documentElement.classList.contains('dark')) {
                    commentDiv.style.backgroundColor = '#450a0a';
                }
            }
        }
        
        alert('Obrigado por reportar o comentário! Nossa equipe irá analisá-lo.');
        closeReportCommentModal();
    }

    function likeComment(button) {
        const commentItem = button.closest('.comment-item');
        const commentId = commentItem.dataset.commentId;
        if (!commentId) return;

        // Recupera os likes do localStorage
        let likedComments = JSON.parse(localStorage.getItem('alerr_likedComments') || '{}');
        if (!likedComments[commentId]) {
            likedComments[commentId] = [];
        }

        const index = likedComments[commentId].indexOf(userId);
        if (index === -1) {
            // Adiciona like
            likedComments[commentId].push(userId);
            button.style.color = '#16a34a';
            button.querySelector('i').className = 'fas fa-thumbs-up';
        } else {
            // Remove like
            likedComments[commentId].splice(index, 1);
            button.style.color = '';
            button.querySelector('i').className = 'far fa-thumbs-up';
        }

        // Atualiza o contador
        const countSpan = button.querySelector('.like-count');
        countSpan.textContent = likedComments[commentId].length;

        // Salva no localStorage
        localStorage.setItem('alerr_likedComments', JSON.stringify(likedComments));
    }

    function toggleResponses(button) {
        const commentItem = button.closest('.comment-item');
        const responsesDiv = commentItem.querySelector('.comment-responses');
        const isHidden = responsesDiv.classList.contains('hidden');
        const responseCountSpan = commentItem.querySelector('.response-count');
        
        if (isHidden) {
            loadResponses(responsesDiv, responseCountSpan);
            responsesDiv.classList.remove('hidden');
        } else {
            responsesDiv.classList.add('hidden');
        }
    }

    function loadResponses(container, countSpan) {
        const responses = [
            { author: "Ana Silva", text: "Concordo com você!", date: "08 de Dezembro de 2025 às 10:00" },
            { author: "João Souza", text: "A resposta correta é a C.", date: "08 de Dezembro de 2025 às 11:30" }
        ];
        
        container.innerHTML = '';
        responses.forEach(resp => {
            const responseEl = document.createElement('div');
            responseEl.className = 'mb-3';
            responseEl.innerHTML = `
                <div class="flex items-start gap-2">
                    <div class="comment-avatar bg-blue-500" style="width:30px; height:30px; font-size:12px">${resp.author.charAt(0)}</div>
                    <div class="flex-1">
                        <h6 class="font-bold text-slate-700 dark:text-slate-300 text-sm">${resp.author}</h6>
                        <div class="text-xs text-slate-500">${resp.date}</div>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${resp.text}</p>
                    </div>
                </div>
            `;
            container.appendChild(responseEl);
        });
        
        if (countSpan) {
            countSpan.textContent = responses.length;
        }
    }

    function toggleSection(section) {
        document.getElementById('explanation-box').classList.add('hidden');
        document.getElementById('question-stats').classList.add('hidden');
        document.getElementById('comments-section').classList.add('hidden');
        
        if (section === 'explanation') {
            const q = appState.questions[appState.index];
            const ans = appState.answers[appState.index];
            const boxExp = document.getElementById('explanation-box');
            boxExp.classList.remove('hidden');
            if (ans.ok) {
                document.getElementById('explanation-text').innerText = q.explanation;
            } else {
                document.getElementById('explanation-text').innerText = 'Responda a questão para ver a explicação.';
            }
        } else if (section === 'stats') {
            document.getElementById('question-stats').classList.remove('hidden');
            updateQuestionStats();
        } else if (section === 'comments') {
            document.getElementById('comments-section').classList.remove('hidden');
        }
        
        appState.currentSection = section;
    }

    function updateQuestionStats() {
        const correctRate = Math.floor(Math.random() * 30) + 70;
        const avgTime = Math.floor(Math.random() * 30) + 15;
        const attempts = Math.floor(Math.random() * 200) + 50;
        
        document.getElementById('stats-correct-rate').textContent = `${correctRate}%`;
        document.getElementById('stats-avg-time').textContent = `${avgTime}s`;
        document.getElementById('stats-attempts').textContent = attempts;
    }

    function useAllAvailableQuestions() {
        const is2018 = document.getElementById('filter-2018').checked;
        let pool = [];
        
        if (is2018) {
            pool = fullDatabase.filter(q => q.is2018);
        } else {
            const checkedModules = Array.from(document.querySelectorAll('.mod-chk:checked')).map(c => c.value);
            pool = fullDatabase.filter(q => checkedModules.includes(q.module));
        }
        
        appState.config.qty = pool.length;
        setQuantity(pool.length);
        document.getElementById('warning-modal').classList.add('hidden');
        startSimulation();
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
        initTheme();
        loadDatabase();
        
        init3dCharts();
        
        setTimeout(() => {
            loadHistory();
        }, 500);

        const savedPref = localStorage.getItem('alerr_save_pref');
        appState.savingEnabled = savedPref !== 'false';
        document.getElementById('toggle-save-history').checked = appState.savingEnabled;
        updateCacheStats();
        
        updateThemeIcon();
        
        updateFilterButtons();
    });
  </script>
</body>
</html>
